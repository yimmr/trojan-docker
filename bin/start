#!/bin/bash

set -e

dump_var() {
    local var_names=("$@")
    for var_name in "${var_names[@]}"; do
        echo "$var_name: ${!var_name}"
    done
}

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$DIR/.." && pwd)"
ENV_FILE="$PROJECT_DIR/.env"
DEFAULT_ENV_NAME=".env.def"
DEFAULT_ENV_FILE="$PROJECT_DIR/$DEFAULT_ENV_NAME"

get_env_var() {
  local var_name=$1
  local var_value=$(grep -E "^${var_name}=" "$ENV_FILE"  | sed -E "s/^${var_name}=(.*)/\1/")
  echo "$var_value"
}

START_ONLY=$([ $# -eq 0 ] && echo true || echo false)
BUILD=false
HOSTNAME=''
PORT=''
PASSWORD=''
WS=`get_env_var WS`
WS_PATH=''
WEB_SSL_PORT=''
SS=`get_env_var SS`
SS_PASSWORD=''

usage() {
    echo "ç®€è¿°ï¼šDocker composeé¡¹ç›®ã€‚ä¸æä¾›å‚æ•°æ—¶ä½¿ç”¨startå¯åŠ¨é¡¹ç›®ï¼Œæä¾›å‚æ•°æ—¶ä½¿ç”¨upå¯åŠ¨é¡¹ç›®ã€‚å‚æ•°å€¼ä¼šè¦†ç›–.envæ–‡ä»¶ä¸­çš„å€¼ï¼Œå¯†ç ä¸ä¼šå†™å…¥æ–‡ä»¶ä¸­ã€‚"
    echo "Usage: $0 [-p Trojanç«¯å£] [-h ä¸»æœºåŸŸå] [-P è®¿é—®å¯†ç ] [-b|--build é‡æ–°æž„å»º] [extra_args...]"
    echo "  -p: Trojanç«¯å£"
    echo "  -h: ä¸»æœºåŸŸå"
    echo "  -P: è®¿é—®å¯†ç ã€‚æœªæŒ‡å®šå¯†ç æ—¶ä¼šç”Ÿæˆéšæœºå¯†ç ï¼ŒåŒæ—¶ä¹Ÿè¦†ç›–æ—§å¯†ç "
    echo "  -w|--wspath: Websocketè·¯å¾„ï¼Œæœªæä¾›åˆ™ç”Ÿæˆéšæœºè·¯å¾„"
    echo "  --no-ws: å…³é—­ Websocket ï¼ˆWSï¼‰è¿žæŽ¥"
    echo "  --ssl-port: ç½‘é¡µHTTPSè¿žæŽ¥ç«¯å£ï¼Œä¸è¦å’ŒTrojanç«¯å£ä¸€æ ·"
    echo "  -s: Shadowsockså¯†ç ï¼Œæä¾›å¯†ç ä¼šè‡ªåŠ¨å¼€å¯AEADåŠ å¯†"
    echo "  --ss: å¼€å¯ShadowsocksåŠ å¯†"
    echo "  --no-ss: å…³é—­ShadowsocksåŠ å¯†"
    echo "  --up: ä»¥UPæ–¹å¼å¯åŠ¨ã€‚æ–¹ä¾¿ç›´æŽ¥é‡ç½®éšæœºå¯†ç "
    echo "  -b|--build: é‡æ–°æž„å»ºé•œåƒå¹¶å¯åŠ¨"
    exit 1
}

PARSED_OPTIONS=$(getopt -o p:h:P:w:s:b --long build,help,no-ws,ws-path:,ssl-port:,ss,no-ss,up -- "$@")
if [ $? -ne 0 ]; then
    echo "æ— æ³•è§£æžé€‰é¡¹"
    exit 1
fi
eval set -- "$PARSED_OPTIONS"
while true; do
    case "$1" in
        -p)
            PORT="$2"
            shift 2
            ;;
        -h)
            HOSTNAME="$2"
            shift 2
            ;;
        -P)
            PASSWORD="$2"
            shift 2
            ;;
        -w|--ws-path)
            WS_PATH="$2"
            shift 2
            ;;
        --no-ws)
            WS=false
            shift
            ;;
        --ssl-port)
            WEB_SSL_PORT="$2"
            shift 2
            ;;
        -s)
            SS_PASSWORD="$2"
            shift 2
            ;;
        --no-ss)
            SS=false
            shift
            ;;
        --ss)
            SS=true
            shift
            ;;
        --up)
            START_ONLY=false
            shift
            ;;
        -b|--build)
            BUILD=true
            shift
            ;;
        --help)
            usage
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "æœªçŸ¥é€‰é¡¹: $1"
            exit 1
            ;;
    esac
done
EXTRA_ARGS="$@"

dump_vars() {
    dump_var 'EXTRA_ARGS' 'PORT' 'HOSTNAME' 'PASSWORD' 'SS' 'WS' 'BUILD' 'START_ONLY'
}

generate_password() {
    # openssl rand -base64 12
    uuidgen
}

generate_ws_path(){
   echo "/wsol-$(shuf -i 10000-99999 -n 1)"
}

setup_env() {
    if [ ! -f "$ENV_FILE" ]; then
        echo -e "\033[32m::\033[0mä¸å­˜åœ¨ .env æ–‡ä»¶ï¼Œæ­£åœ¨ä»Ž $DEFAULT_ENV_NAME å¤åˆ¶..."
        if [ -f "$DEFAULT_ENV_FILE" ]; then
            cp "$DEFAULT_ENV_FILE" "$ENV_FILE"
            echo -e "\033[32m::\033[0må·²åˆ›å»º .env æ–‡ä»¶"
        else
            echo -e "\033[31m::\033[0mé”™è¯¯ï¼šä¸å­˜åœ¨ $DEFAULT_ENV_NAME æ–‡ä»¶"
            exit 1
        fi
    fi

    local VARS=("HOSTNAME" "PORT" "WS" "WS_PATH" "WEB_SSL_PORT" "SS" "SS_PASSWORD")
    local env_content=$(cat "$ENV_FILE")
    echo -e "\033[32m::\033[0mæ­£åœ¨æ›´æ–° .env æ–‡ä»¶..."
    for var in "${VARS[@]}"; do
        if [ -n "${!var}" ]; then
            local escaped_value=$(printf '%s\n' "${!var}" | sed 's:[\/&]:\\&:g')
            env_content=$(echo "$env_content" | sed -E "s/^($var=).*/\1$escaped_value/")
        fi
    done
    echo "$env_content" > "$ENV_FILE"

    echo -e "\033[32m::\033[0må·²æ›´æ–° .env æ–‡ä»¶"
}

docker_up() {
    if [ -z "$PASSWORD" ]; then
        PASSWORD=$(generate_password)
    fi
    if [ -z "$WS_PATH" ]; then
        WS_PATH=$(generate_ws_path)
    fi
    if [ -n "$SS_PASSWORD" ]; then
        SS=true
    fi
    export PASSWORD
    setup_env
    echo $WEB_SSL_PORT
    docker-compose up -d $EXTRA_ARGS
}

to_pascal_case() {
    local input="$1"
    local output=""
    local IFS='.'
    read -ra parts <<< "$input"
    for part in "${parts[@]}"; do
        output+=$(echo "${part:0:1}" | tr '[:lower:]' '[:upper:]')
        output+=$(echo "${part:1}" | tr '[:upper:]' '[:lower:]')
    done
    echo "$output"
}

domain_to_agent_name() {
    local domain="$1"
    local subdomain=""
    local main_domain=""
    if [[ "$domain" =~ ^([^.]+)\.([^.]+\.[^.]+)$ ]]; then
        subdomain="${BASH_REMATCH[1]}"
        main_domain="${BASH_REMATCH[2]}"
    elif [[ "$domain" =~ ^([^.]+\.[^.]+)$ ]]; then
        main_domain="${BASH_REMATCH[1]}"
    fi

    if [[ -n "$subdomain" ]]; then
        to_pascal_case "$subdomain"
    else
        to_pascal_case "${main_domain%.*}"
    fi
}

declare -A NodeIconMap=(
  ["cn"]='ðŸ‡¨ðŸ‡³'
  ["hk"]='ðŸ‡­ðŸ‡°'
  ["sg"]='ðŸ‡¸ðŸ‡¬'
  ["us"]='ðŸ‡ºðŸ‡¸'
  ["jp"]='ðŸ‡¯ðŸ‡µ'
  ["kr"]='ðŸ‡°ðŸ‡·'
  ["gb"]='ðŸ‡¬ðŸ‡§'
  ["fr"]='ðŸ‡«ðŸ‡·'
  ["de"]='ðŸ‡©ðŸ‡ª'
  ["ie"]='ðŸ‡®ðŸ‡ª'
  ["ca"]='ðŸ‡¨ðŸ‡¦'
  ["in"]='ðŸ‡®ðŸ‡³'
)

domain_to_agent_name_with_icon(){
    local icon=""
    local name=$(domain_to_agent_name "$@")
    for key in "${!NodeIconMap[@]}"; do
        if [[ "${name,,}" == "${key,,}"* ]]; then
            name="${name}${NodeIconMap[$key]}"
            break
        fi
    done
    echo "$name"
}

build_agent_node_yml() {
   if [[ $WS == true ]]; then
        local network='ws'
        local wsheader=", headers: { Host: $WS_HOST }"
        local wsopt="
    ws-opts: { path: '$WS_PATH' ${WS_HOST:+$wsheader} },"
    else
        local network='tcp'
    fi
    echo "
{
    name: '$(domain_to_agent_name_with_icon $HOSTNAME)',
    type: trojan,
    server: $HOSTNAME,
    port: $PORT,
    password: $PASSWORD,
    udp: true,
    network: $network, $wsopt
    sni: $SSL_SNI,
    skip-cert-verify: false
}" | tr -s '[:space:]' ' '
}

if [[ $BUILD == true ]]; then
    EXTRA_ARGS="$EXTRA_ARGS --build"
fi

if [[ $START_ONLY == true ]]; then
    docker-compose start $EXTRA_ARGS
else
    docker_up
fi

if docker-compose ps | grep -q "Up"; then
    docker image prune -f
    source $ENV_FILE

    network_protocol=`[[ $WS == true ]] && echo 'ws' || echo 'tcp'`
    echo -e "TrojanæœåŠ¡å·²å¯åŠ¨..."
    echo -e "ä¸»åŸŸ: \033[32m$HOSTNAME\033[0m"
    echo -e "ç«¯å£: \033[32m$PORT\033[0m"
    echo -e "å¯†ç : \033[32m${PASSWORD:-æ— å˜åŒ–}\033[0m"
    echo -e "SNI: \033[32m$SSL_SNI\033[0m"
    echo -e "ä¼ è¾“åè®®: \033[32m$network_protocol\033[0m"
    echo -e "\033[30mAlpn: ç•™ç©ºæˆ–é€‰h3,h2\033[0m"
    if [[ $WS == true ]]; then
        echo -e "WSè·¯å¾„: \033[32m$WS_PATH\033[0m"
        echo -e "WSåŸŸå: \033[32m$WS_HOST\033[0m"
    fi
    if [[ $SS == true ]]; then
        echo -e "\033[30må·²å¼€å¯Shadowsocks(SS)åŠ å¯†\033[0m"
        echo -e "SSå¯†ç : \033[32m$SS_PASSWORD\033[0m"
    fi
    echo -e "ClashèŠ‚ç‚¹: \033[32m$(build_agent_node_yml)\033[0m"
else
    echo -e "\033[31mæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚\033[0m"
fi