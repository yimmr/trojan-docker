# trojan-docker

> Docker 一键部署 Trojan 服务端，科学上网实践

本项目简单做一些基本调优，更复杂的需求则要自定义。

-   一键部署，服务器只需开放 `80,443` 端口，使用域名访问就如同正常的 HTTPS 网站（这也是该协议主要特征）
-   禁用 HTTP 访问
-   证书自动化
-   精简配置，最简就只需输入域名
-   ...

以下内容有不理解的可以查找教程操作，如：域名解析至服务器、证书申请等。本项目没有进行各种兼容性测试，如有问题请提 issue。

---

## 服务器环境要求

-   系统：Debian/Ubuntu
-   软件：docker、git

一键部署时可选自动安装以上软件。未在其他 Linux 发行版测试，可能会缺少其他依赖，请自行安装所需依赖即可。

## 快速部署

如果已满足服务器环境要求，可用一键安装脚本部署服务端，执行脚本时需要提供必要信息，按照提示输入并按回车即可。

```shell
sudo bash -c "$(wget -qO- https://raw.githubusercontent.com/yimmr/trojan-docker/main/bin/install_server.sh)"
```

## 部署细节

-   部署服务需要：**域名**、**TLS 证书**
-   准备好**域名**和**服务器**，并将域名的 A 记录指向服务器 IP
-   安装 TLS 证书：
    -   全链证书和私钥文件名分别是：`fullchain.pem` 和 `privkey.pem`。 全链证书文件包含服务器证书和中间证书
    -   如果已有证书，把证书文件放到`cert`目录下即可，同时检查文件名是否正确
    -   如果没有证书请参考[**自动申 TLS 请证书**](#自动申请-tls-证书)部分
-   执行一键安装脚本，输入域名后回车，后续按提示操作即可，最后可以不输入密码，会生成随机长密码
-   如果手动更新 `cert` 证书目录，请记得在项目目录下执行 `sudo bin/restart` 重启
-   部署完成或通过 UP 启动后，终端会显示密码等信息，**密码并不直接保存在服务器上**。

### 自动申请 TLS 证书

本项目简单封装了通过 Docker 获取证书的脚本，具体用法可执行 `sudo bin/cert` 查看。

-   请全程以 `root` 用户或 `sudo` 方式执行命令，否则可能无法从容器内复制证书到主机
-   如果一键安装时提供 Cloudflare API 令牌，则会自动处理证书的申请、部署、自动更新
-   如果一键安装时未提供令牌，安装后可以执行脚本操作证书
-   目前仅支持通过 Cloudflare DNS 验证申请证书，其他验证方式需自行修改脚本

> 注意：脚本以 root 用户身份运行 certbot 容器申请证书。申请成功后，如果终端是非 root 用户，则看不到 certbot 目录下的证书，切换至 root 用户才看到。

#### 获取 Cloudflare API 令牌

-   注册登录[Cloudflare](https://cloudflare.com/zh-cn/)
-   依次点击：个人资料 - API 令牌 - 创建令牌 - 模板选择编辑区域 DNS
-   在区域资源选择域名后 - 继续 - 创建令牌 - 复制令牌

### 简单例子

-   在 [GoDaddy](https://www.godaddy.com/) 申请一个便宜域名，购买一个海外服务器（如：亚马逊云）
-   购买域名或服务器后，请检查是否有开自动续费，可以将其关闭。
-   注册 Cloudflare 并在个人主页添加站点，填自己域名，选免费计划，按提示一步步操作即可
-   去 GoDaddy 把**域名服务器**改为 Cloudflare 提供的域名服务器 （NS 地址），后续就在 Cloudflare 管理域名解析
-   去 Cloudflare 变更域名 DNS 解析：A 记录指向服务器 IP
-   使用 SSH 终端登录服务器，一键部署服务端
-   使用 v2rayN 添加服务器并测试连接

## 客户端连接简述

服务端启动时会打印出：域名、端口、密码，复制到客户端添加配置。v2rayN 例子：

-   左上角点击服务器 - 添加 Trojan 服务器
-   填写必要的配置项，没有的留空即可：
    -   别名：根据喜好写个名称
    -   地址：服务端显示的域名
    -   端口：服务端显示的端口
    -   密码：服务端显示的密码
    -   传输协议：选 tcp 。若开启 WS 则选 WS 并在路径填写服务端显示的路径
    -   传输层安全：选 tls
    -   跳过证书验证：选 false
-   右键新增的服务器选择测试服务器速度，若没有英文报错则表示连通

## 客户端连接失败

-   首先确保域名能访问服务端的网站，打不开则说明域名解析不对或部署失败等
-   检查密码、域名和端口是否和服务端输出一致
-   可能是证书安装不对，先尝试把跳过证书验证设为 true
-   如果 Clouldflare DNS 记录显示已代理，请在服务端开启 WS ，客户端用 WS 传输协议
-   关闭 Clouldflare 的 Under Attack 模式
-   还是不行，尝试把传输协议改为 tcp 并清空路径
-   还是不行，服务端部署失败或未运行，或其他问题
-   还是不行，.....

## 项目脚本使用示例

连接终端后，先进入到项目目录，以下命令需要在项目目录下执行：

```shell
# 启动服务。不带参数仅简单启动，带参数将会重置客户端访问密码
sudo bin/start

# 重建镜像并启动服务
sudo bin/start --build

# 查看启动脚本的用法
sudo bin/start --help

# 暂停服务
sudo bin/stop

# 下线并删除服务
sudo bin/stop down

# 重启服务
sudo bin/restart

# 更新项目代码并重启服务
sudo bin/update

# 查看证书脚本的用法
sudo bin/cert --help
```

## 自定义 Trojan-gop 配置

配置文件位于项目目录的 `trojan/templates/config.json`，这不是一个合法的 JSON 文件，只是一个配置模板。

-   支持环境变量插值

## 自定义网站内容

默认网站位于 [web](./nginx/web) 目录下，可以替换为其他内容。

## 故障排除

使用不同端口访问服务器会有不同情况，以下只考虑 Trojan 监听的 HTTPS 端口和 Web 监听的 HTTP 端口。
其他端口不进入 Trojan 或 Web 服务。
非 TLS 协议访问 HTTPS 服务的端口，则握手失败，一般会出现 400 错误页

> 某些情况下，即使服务器能响应内容，浏览器也会阻止页面访问，可使用 Postman 测试网站访问。

-   使用 HTTPS 访问先进入 Trojan：
    -   TLS 握手成功且是有效请求：则正常传输（只要 Trojan 能启动，无论能否打开网页）
    -   TLS 握手成功但无效请求：则转发 remote_addr:remote_port 的 HTTP 网站：
        -   若是本机网站：强制跳到 https 时，可能形成死循环，应检查 Nginx 配置
        -   若是本机网站：无法正常响应时，网页打不开
        -   若是其他网站：略
    -   TLS 握手失败：则优先转发 fallback_addr:fallback_port 的 HTTP/HTTPS 网站。（此外源码还有其他 case）
-   如果与 Clouldflare 部署：
    -   最先进入 CF 的服务器，连接协议根据 TLS 模式有不同情况：
        -   总以 HTTP 访问源站
        -   自动选择 HTTP/HTTPS 访问源站
        -   总以 HTTPS 访问源站
    -   CF 回源时到达源站（服务器）：
        -   CF 无法从源站获取内容时，页面一般显示 502 错误
        -   HTTPS 请求：先进入 Trojan ，处理方式参考前面描述
        -   HTTP 请求：不进入 Trojan ，Nginx 处理网页内容
        -   总是 HTTP 请求：无法使用代理
        -   总是 HTTPS 请求：总会进入 Trojan 处理
